<head>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
	
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
	
</head>

<script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

<style>

.form-control {
	width: 100px;
}

	
</style>

<nav class="navbar navbar-light bg-light">
	<div>
		<div class="row">
						<button id="patientButton" type="button" class="btn btn-light btn">Call Center Manager</a></button>
						<button id="patientButton" type="button" class="btn btn-light btn"><i class="fas fa-clinic-medical"></i><a href="#patientAnchor"> Completed Calls </a><span class="badge badge-primary badge-success" id="patientCountNo">435</span></button>
												
						<button id="allergyButton" type="button" class="btn btn-light btn"><i class="fas fa-capsules"></i><a href="#allergyAnchor"> Specialty Referrals </a><span class="badge badge-secondary badge-success" id="allergyCountNo">10</span></button>
						
							<button id="vitalsButton" type="button" class="btn btn-light btn"><i class="fas fa-calendar-alt"></i><a href="#vitalsAnchor"> Cancelled Appointments </a><span class="badge badge-secondary badge-danger" id="vitalsCountNo">5</span></button>
						
						<button id="labsButton" type="button" class="btn btn-light btn"><i class="far fa-calendar-alt"></i><a href="#labsAnchor"> Labs Scheduled </a><span class="badge badge-secondary badge-success" id="labsCountNo">20</span></button>
						
					   <button type="button" class="btn btn-primary" onclick="launchUrl()">Admin</button>
					
					</div>
				</div>
		</div>		
	</div>
</div>	
</nav>
	<br>

	<h5>Today's Highlights</h5>
	
	Check out our stats. We're saving some lives today, people!
	<br>

<br>
<div class="col">
	<a name="patientAnchor"></a>
	<h6 id="patientTop" hidden><i class="fas fa-user"></i> Patient Demographics</h6>
	<div class="row" id="patientHeader"></div>
	
	<br>

	<a name="encounterAnchor"></a>
	<h6 id="encounterTop" hidden><i class="fas fa-clinic-medical"></i> Encounters</h6>
		<div class="row" id="encounterHeader"></div>

	<br>

	<a name="allergyAnchor"></a>
	<h6 id="allergyTop" hidden><i class="fas fa-capsules"></i> Allergies</h6>
	<div class="row" id="allergyHeader"></div>
	
	<br>

	<a name="conditionAnchor"></a>
	<h6 id="conditionTop" hidden><i class="fas fa-diagnoses"></i> Conditions</h6>
	<div class="row" id="conditionHeader"></div>
	
	<br>

	<a name="documentAnchor"></a>
	<h6 id="docTop" hidden><i class="fas fa-laptop-medical"></i> Documents</h6>
	<div class="row" id="docHeader"></div>
	
	<br>

	<a name="medAnchor"></a>
	<h6 id="medTop" hidden><i class="fas fa-prescription-bottle-alt"></i> Historical Meds</h6>
	<div class="row" id="medHeader"></div>
	
	<br>
	
	<a name="procedureAnchor"></a>
	<h6 id="procedureTop" hidden><i class="far fa-calendar-alt"></i> Procedures</h6>
	<div class="row" id="procedureHeader"></div>
</div>



<script>

function launchUrl() {
	var state = uuidv4();
	var nonce = uuidv4();
	
	console.log(state)
	console.log(nonce)
	
	var config = {
			client_id: "0oa1vk06xoo6xSAE5357",
			redirect_uri: "https://adamacrown1.github.io/webapp/admin/",
			authorization_endpoint: "https://dev-602311.okta.com/oauth2/v1/authorize",
			token_endpoint: "https://dev-602311.okta.com/oauth2/v1/token",
			requested_scopes: "openid profile okta.users.read okta.users.manage okta.roles.manage okta.roles.read okta.groups.read okta.groups.manage",
	
	};

	var url = config.authorization_endpoint 
				+ "?response_type=token"
				+ "&client_id="+encodeURIComponent(config.client_id)
				+ "&state="+encodeURIComponent(state)
				+ "&scope="+encodeURIComponent(config.requested_scopes)
				+ "&redirect_uri="+encodeURIComponent(config.redirect_uri)
				+ "&nonce="+"1234";
		// Redirect to the authorization server
		window.location = url;
		console.log(url);
			
			function uuidv4() {
				return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
					var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
					 return v.toString(16);
					
				});
			}
		
		}
	
	</script>

<script>
	var tenantId = "0b8a0111-e8e6-4c26-a91c-5069cbc6b1ca"

	var x = "";
	var y;
	var json;

	var testObj;
	var sb;
	var data;
	var textStatus;
	var patientId; // = "5912007"; // 5484007 DARA KIM; 1766011 JENNIFER PETERS; 4768011 KEITH SCHONHOFF
	var testID;
	var y1;
	var jsonBody;
	var patientName;
	var patientPayload;
	var medicationPayload;
	var medCount;
	var docCount;
	var docPayload;
	var apptCount;
	var apptPayload;
	var allergyId;
	
	var urlFirst
	var urlTrail = ""
	var urlNext =  ""

	function mainCall() { 

		patientId = $('#patientIdInput').val()
		console.log("pt ID:" + patientId)
	
		if (patientId == "") {
		
		document.getElementById('patientIdInput').setAttribute('class','form-control is-invalid')
		
			return
		
		}
		
		document.getElementById('patientIdInput').setAttribute('class','form-control')
	
		//getPatient();
		//getEncounter();
		//getAllergy();
		//getCondition();
		
		//In Dev
		getProcedure();
		
		//Pagination
		//getMedicationStatement();
	
	}
		
	function getPatient() {

		callAPI("Patient/", "", function () {
		
		//Name, DOB, Age, Status
		
			patientPayload = jsonBody
			// console.log(patientPayload)
			
				if (patientPayload.id != "") {
	
				// identify button to update
				var d = document.getElementById("patientCountNo");
				
				// add className of color coding, green
				d.className += " badge-success";
			
				}
			
			// get patient name
			patientName = patientPayload.name[0].text
			// console.log(patientName)
			
			// get patient DOB
			patientBirthDate = patientPayload.birthDate
			console.log(patientBirthDate)
			
			// get patient gender
			patientGender = patientPayload.gender
			// console.log(patientGender)
			
			var addTo = document.getElementById("patientHeader");
		
			addTo.innerHTML += '<div class="card" style="width: 18rem;">' +
				'<div class="card-body">' +
					'<h6 class="card-title" id="patientNameCard">' + patientName + '</h6>' +
					'<h6 class="card-subtitle mb-2 text-muted" id="patientGender">' + patientGender + '</h6>' +
					'<h6 class="card-subtitle mb-2 text" id="patientBirthDate">DOB: ' + patientBirthDate + '</h6>' +
				'</div>' +
			'</div>'

			document.getElementById('patientTop').removeAttribute('hidden')
			document.getElementById("patientCountNo").innerHTML = 1
			}
		);

	}
	
	function getEncounter() {

				callAPI("Encounter/?patient=", "", function () {
				
				encounterPayload = jsonBody
				console.log(encounterPayload)

				encounterCount = encounterPayload.total
				
				if (encounterCount >=1) {
					
					var d = document.getElementById("encounterCountNo");
					d.className += " badge-success";
				
				}
				
				document.getElementById("encounterCountNo").innerHTML = encounterCount
				
				var step;
								
				for (step = 0; step < encounterCount ; step++) {
					// Runs step times, with values of step 0 through upperbound of conditionCount
					
					// get condition name
					encounterName = encounterPayload.entry[step].resource.class
					console.log(encounterName)
					
					encounterLocationDisplay = encounterPayload.entry[step].resource.location[0].location.display
					
					// encounterPractitioner = encounterPayload.entry[step].resource.participant[0].individual.display
					
					encounterLastUpdated = encounterPayload.entry[step].resource.meta.lastUpdated
									
					// dynamically construct HTML card, add to html body
					
					var addTo = document.getElementById("encounterHeader");
				
					addTo.innerHTML += '<div class="card" style="width: 18rem;">' +
						'<div class="card-body">' +
							'<h5 class="card-title" id="encounterNameCard">' + encounterName + '</h5>' +
							'<h6 class="card-subtitle mb-2 text-muted" id="patientGender">' + encounterLocationDisplay + '</h6>' +
							'<h6 class="card-subtitle mb-2 text" id="patientLastUpdated">Updated: ' + new Date(encounterLastUpdated) + '</h6>' +
						'</div>' +
					'</div>'
					
					// remove hidden attribute of concept header
					document.getElementById('encounterTop').removeAttribute('hidden')
					
				}
				// add count to header
				var addTo = document.getElementById("encounterTop");
				addTo.innerHTML += " - [" + encounterCount + "]"
				
				}
				);

			}
	
	function getAllergy() {

		callAPI("AllergyIntolerance/?patient=", "", function () {
		
		// construct allergy JSON body
		allergyPayload = jsonBody
		console.log(allergyPayload)

		// determine count of allergies
		// if 0, >=1, and <=50, will return with total
		// >50, will not return with total, and will be paginated -> need to handle
		allergyCount = allergyPayload.total
		console.log(allergyCount)
		
		// determine count, and if badge color changes to show data is present
		if (allergyCount >=1) {
			
			// identify button to update
			var d = document.getElementById("allergyCountNo");
			
			// add className of color coding, green
			d.className += " badge-success";
		
			}
		
		// https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Loops_and_iteration
		
		var step;
						
		for (step = 0; step < allergyCount ; step++) {
			// Runs step times, with values of step 0 through upperbound of allergyCount
			
			// get allergy ID
			allergyId = allergyPayload.entry[step].resource.id
			console.log(allergyId)
			
			// get allergy name
			allergyName = allergyPayload.entry[step].resource.substance.text
			console.log(allergyName)
			
			// get allergy category
			allergyCategory = allergyPayload.entry[step].resource.category
			console.log(allergyCategory)
		
			// get allergy onset date
			allergyOnset = allergyPayload.entry[step].resource.onset
			console.log(allergyOnset)
			
			// get allergy status
			allergyStatus = allergyPayload.entry[step].resource.status
			console.log(allergyStatus)
			
			allergyLastUpdated = allergyPayload.entry[step].resource.recordedDate
			console.log(allergyLastUpdated)
			
			// dynamically construct HTML card, add to html body
			
			var addTo = document.getElementById("allergyHeader");
		
			addTo.innerHTML += '<div class="card" style="width: 18rem;">' +
				'<div class="card-body">' +
					'<h5 class="card-title" id="allergyNameCard">' + allergyName + '</h5>' +
					'<h6 class="card-subtitle mb-2 text-muted" id="allergyCategoryCard">' + allergyCategory + '</h6>' +
					'<h6 class="card-subtitle mb-2 text-muted" id="allergyStatusCard">' + allergyStatus + '</h6>' +
					'<h6 class="card-subtitle mb-2 text" id="allergyOnsetCard">Onset: ' + allergyOnset + '</h6>' +
					'<h6 class="card-subtitle mb-2 text" id="allergyLastUpdatedCard">Recorded: ' + new Date(allergyLastUpdated) + '</h6>' +
					'<p class="card-text"></p>' +
				'</div>' +
			'</div>'
		
			// remove hidden attribute of concept header
			document.getElementById('allergyTop').removeAttribute('hidden')
			
			}
		
			// push allergy count into HTML element/card
			document.getElementById("allergyCountNo").innerHTML = allergyCount
			
			// add count to header
			var addTo = document.getElementById("allergyTop");
			addTo.innerHTML += " - [" + allergyCount + "]"
		
			}
		);

	}
	
	function getCondition() {

		callAPI("Condition/?patient=", "", function () {
		
		conditionPayload = jsonBody
		console.log(conditionPayload)

		conditionCount = conditionPayload.total
		
		if (conditionCount >=1) {
			
			var d = document.getElementById("conditionCountNo");
			d.className += " badge-success";
		
		}
		
		document.getElementById("conditionCountNo").innerHTML = conditionCount
		
		var step;
						
		for (step = 0; step < conditionCount ; step++) {
			// Runs step times, with values of step 0 through upperbound of conditionCount
			
			// get condition name
			conditionName = conditionPayload.entry[step].resource.code.text
			// console.log(conditionName)
			
			// get condition category (problem, diagnosis)
			conditionCategory = conditionPayload.entry[step].resource.category.text
			// console.log(conditionCategory)
			
			// get condition status
			conditionStatus = conditionPayload.entry[step].resource.clinicalStatus
			// console.log(conditionStatus)
			
			// get condition date recorded
			conditionDateRecorded = conditionPayload.entry[step].resource.dateRecorded
		// console.log(conditionDateRecorded)
							
			// dynamically construct HTML card, add to html body
			
			var addTo = document.getElementById("conditionHeader");
		
			addTo.innerHTML += '<div class="card" style="width: 18rem;">' +
				'<div class="card-body">' +
					'<h5 class="card-title" id="conditionNameCard">' + conditionName + '</h5>' +
					'<h6 class="card-subtitle mb-2 text-muted" id="conditionCategoryCard">' + conditionCategory + '</h6>' +
					'<h6 class="card-subtitle mb-2 text-muted" id="conditionStatusCard">' + conditionStatus + '</h6>' +
					'<h6 class="card-subtitle mb-2 text" id="conditionLastUpdatedCard">Recorded: ' + new Date(conditionDateRecorded) + '</h6>' +
					'<p class="card-text"></p>' +
				'</div>' +
			'</div>'
			
			// remove hidden attribute of concept header
			document.getElementById('conditionTop').removeAttribute('hidden')
			
		}
		// add count to header
		var addTo = document.getElementById("conditionTop");
		addTo.innerHTML += " - [" + conditionCount + "]"
		
		}
		);

	}
		
	function getMedicationStatement() {
	
		var totalCount = 3
		
		for (step = 0; step < totalCount ; step++) {
			
			if (step = 0) {
				
				console.log("step = 0")
				urlFirst = "MedicationStatement/?patient="
				urlTrail = "&_count=60"
				console.log(urlFirst)
				step = totalCount
				console.log(step)
				
			} else {
				
				console.log("step = " + step)
				url = urlNext
				urlTrail = ""
				step = step + 2
				
			}
		}
				
			callAPI(urlFirst, urlTrail, function () {
			
				medPayload = jsonBody
				console.log(medPayload)
			
				var medCount = medPayload.total
				console.log(medCount)
				
					if (medCount == null) {
				
					if (medPayload.link[1].relation = "next") {
					
					console.log("next URL")
					//urlNext = medPayload.link[1].url
					//console.log(urlNext)
					
				//	medCount1 = Object.keys(medPayload.entry).length
				//	console.log("Count = " + medCount1)
				//	medCount = medCount1
				//	console.log(medCount)
					
						}
			
					}
					
			// Runs step times, with values of step 0 through upperbound of medCount
			
			// get medName
			medName = medPayload.entry[step].resource.medicationCodeableConcept.text
			// console.log(medName)
			
			// get med category
			//medCategory = medPayload.entry[step].resource.extension[0].valueCodeableConcept.text						
			// console.log(medCategory)
			
			// get med status
			medStatus = medPayload.entry[step].resource.status
			// console.log(medStatus)
			
			// get med date asserted
			medDateAsserted = medPayload.entry[step].resource.dateAsserted
			// console.log(medDateAsserted)
							
			// dynamically construct HTML card, add to html body
			
			var addTo = document.getElementById("medHeader");
		
			addTo.innerHTML += '<div class="card" style="width: 18rem;">' +
				'<div class="card-body">' +
					'<h5 class="card-title" id="medNameCard">' + medName + '</h5>' +
					//'<h6 class="card-subtitle mb-2 text-muted" id="medCategoryCard">' + medCategory + '</h6>' +
					'<h6 class="card-subtitle mb-2 text-muted" id="medStatusCard">' + medStatus + '</h6>' +
					'<h6 class="card-subtitle mb-2 text" id="medLastUpdatedCard">Asserted: ' + new Date(medDateAsserted) + '</h6>' +
					'<p class="card-text"></p>' +
				'</div>' +
			'</div>'

			
				}
			
			);
			
			// remove hidden attribute of concept header
			document.getElementById('medTop').removeAttribute('hidden')
			
			// add count to header
			document.getElementById("medCountNo").innerHTML = medCount
		
		}
		
		// add count to header
		var addTo = document.getElementById("medTop");
		addTo.innerHTML += " - [" + medCount + "]";
		
		//var d = document.getElementById("medCountNo");
		//d.className += " badge-success";	

		function getProcedure() {

				callAPI("Procedure/?patient=", "", function () {
				
				//Name, DOB, Age, Status
				
					procedurePayload = jsonBody
					console.log(procedurePayload)
					
						if (procedurePayload.total != "") {
			
						procedureCount = Object.keys(procedurePayload.entry).length
						console.log(procedureCount)
			
						document.getElementById('procedureCountNo').innerHTML = procedureCount
						
						// identify button to update
						var d = document.getElementById("procedureCountNo");
						
						// add className of color coding, green
						d.className += " badge-success";
					
						}
					
					for (step = 0; step < procedureCount ; step++) {


					procedureName = procedurePayload.entry[step].resource.code.text
					console.log(procedureName)
					
					var addTo = document.getElementById("procedureHeader");
				
					addTo.innerHTML += '<div class="card" style="width: 18rem;">' +
						'<div class="card-body">' +
							'<h6 class="card-title" id="patientNameCard">' + procedureName + '</h6>' +
						'</div>' +
					'</div>'

					document.getElementById('procedureTop').removeAttribute('hidden')
					document.getElementById('procedureCountNo').innerHTML = procedureCount
					}
				}
				);

			}


	function callAPI(APICALL, trailing, callback) {

		var envUrl = "sandboxcerner.com"
		var urlCall = "https://fhir-open." + envUrl + "/dstu2/" + tenantId + "/" + APICALL + patientId + trailing
		console.log(urlCall)

		$.getJSON({
			type: "GET",
			url: urlCall,
			beforeSend: function(xhr) {
					xhr.setRequestHeader('Accept', 'application/json')
			},
			success: function(data, textStatus, jqXHR) {

            jsonBody = data

				var statusCode = jqXHR.status;
				console.log(APICALL + " - " + jqXHR.status + " " + jqXHR.statusText)
			
			callback();
			},

			error: function(testObj, textStatus, jqXHR) {
				
				var statusText = jqXHR.statusText;
				console.log(jqXHR.statusText)

				console.log(APICALL)
				console.log(data)

			}
		});

	}
	
	
	function callNEXTAPI(urlCall, callback) {

			var envUrl = "sandboxcerner.com"
			var urlCall = "https://fhir-open." + envUrl + "/dstu2/" + tenantId + "/" + APICALL + patientId + trailing

			$.getJSON({
				type: "GET",
				url: urlCall,
				beforeSend: function(xhr) {
						xhr.setRequestHeader('Accept', 'application/json')
				},
				success: function(data, textStatus, jqXHR) {

	            jsonBody = data

					var statusCode = jqXHR.status;
					console.log(APICALL + " - " + jqXHR.status + " " + jqXHR.statusText)
				
				callback();
				},

				error: function(testObj, textStatus, jqXHR) {
					
					var statusText = jqXHR.statusText;
					console.log(jqXHR.statusText)

					console.log(APICALL)
					console.log(data)

				}
			});

		}

	
	// -------------------------------------------
	// POST
	// -------------------------------------------
	
	function createPatient() {

				callPOSTAPI("Patient", function () {
				
				patientPOSTPayload = jsonBody
				console.log(patientPOSTPayload)
				
					}
				);

			}
	
	
	// add Token call
	


		
	// Call POST API
	
	function callPOSTAPI(nextURL, callback) {

			var urlCall = nextURL

			$.getJSON({
				type: "POST",
				url: urlCall,
				beforeSend: function(xhr) {
						xhr.setRequestHeader('Accept', 'application/json'),
						xhr.setRequestHeader('Content-Type', 'application/json+fhir')
				},
				success: function(data, textStatus, jqXHR) {

	            jsonBody = data

					var statusCode = jqXHR.status;
					console.log(APICALL + " - " + jqXHR.status + " " + jqXHR.statusText)
				
				callback();
				},

				error: function(testObj, textStatus, jqXHR) {
					
					var statusText = jqXHR.statusText;
					console.log(jqXHR.statusText)

					console.log(APICALL)
					console.log(data)

				}
			});

		}

</script>

</script>







